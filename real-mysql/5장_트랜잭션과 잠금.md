<!-- TOC -->

- [트랜잭션](#%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98)
- [MySQL 엔진의 잠금](#mysql-%EC%97%94%EC%A7%84%EC%9D%98-%EC%9E%A0%EA%B8%88)
    - [글로벌 락](#%EA%B8%80%EB%A1%9C%EB%B2%8C-%EB%9D%BD)
    - [테이블 락](#%ED%85%8C%EC%9D%B4%EB%B8%94-%EB%9D%BD)

<!-- /TOC -->


> **격리 수준**이라는 것은 하나의 트랜잭션 내에서 또는 여러 트랜잭션 간의 작업 내용을 어떻게 공유하고 차단할 것인지를 결정하는 레벨을 의미한다.

# 트랜잭션

MyISAM에서는 트랜잭션 기능이 지원되지 않아 만약 5건의 데이터를 `INSERT`중 4번째에서 기본키 값 중복이 일어나서 작업이 끝난다면 1,2,3번째 데이터는 `INSERT`가 되어있다.  
이러한 현상을 **부분 업데이트**라고 표현하며 **테이블 데이터의 정합성을 맞추는데 상당히 어렵다.**  
  
**트랜잭션이란 그만큼 애플리케이션 개발에서 고민해야 할 문제를 줄여주는 아주 필수적인 DBMS의 기능이라는 점을 기억해야 한다.**  
트랜잭션 또한 DBMS의 커넥션과 동일하게 꼭 필요한 최소의 코드에만 적용하는 것이 좋다.  
**프로그램의 코드가 데이터베이스 커넥션을 가지고 있는 범위와 트랜잭션이 활성화돼 있는 프로그램의 범위를 최소화 해야한다.**  
  
# MySQL 엔진의 잠금

MySQL의 잠금 처리는 **MySQL 엔진 레벨**과 **스토리지 엔진 레벨**의 두 가지 레이어로 처리된다.  
- MySQL 엔진은 스토리지 엔진을 제외한 나머지 부분으로 이해하면 된다.

MySQL 엔진 레벨의 잠금은 모든 스토리지 엔진에 영향을 미치지만, 
- 테이블 데이터 동기화를 위한 테이블 락 이외에도 테이블의 구조를 잠그는 **메타데이터 락**그리고 사용자의 필요에 맞게 사용할 수 있는 **네임드 락**이라는 잠금 기능도 제공한다.

스토리지 엔진 레벨의 잠금은 스토리지 엔진간 상호 영향을 미치지 않는다.  

## 글로벌 락

`FLUSH TABLES WITH READ LOCK` 명령으로 **MySQL에서 제공하는 가장 범위가 큰 글로벌 락**을 획득할 수 있다.  
한 세션에서 글로벌 락을 획득하면 다른 세션에서 `SELECT`를 제외한 **대부분의 DDL 문장**이나 **DML 문장**을 실행하는 경우 락이 해제될 때까지 대기 상태로 남는다.  
`FLUSH TABLES WITH READ LOCK` 명령 실행과 동시에 MySQL 서버에 존재하는 모든 테이블을 닫고 잠금을 건다.
- 작업 대상 테이블이나 데이터베이스가 다르더라도 MySQL 서버 전체에 영향을 미친다.
- DDL이나 DML을 수행하고 있는 트랜잭션이 있다면 트랜잭션이 끝날 때 까지 기다린다.
  
MySQL 8.0 부터는 조금 더 가벼운 글로벌 락인 **백업 락**이 도입됐다.  
백업 툴들이 실행되는 도중에 스키마가 변경되면 백업이 실패되었지만, 이 실패를 막기 위해 DDL 명령이 실행되면 복제를 일시 중지하는 역할도 한다.  

```sql
LOCK INSTANCE FOR BACKUP;
// 백업 실행
UNLOCK INSTANCE;
```

위와 같이 **백업 락**을 획득하면 모든 세션에서 아래의 명령은 실행할 수 없다.  
1. 데이터베이스 및 테이블 등 모든 객체 생성 및 변경, 삭제
2. [REPAIR TABLE](https://dev.mysql.com/doc/refman/8.0/en/repair-table.html)과 [OPTIMIZE TABLE](https://dev.mysql.com/doc/refman/8.0/en/optimize-table.html) 명령
3. 사용자 관리 및 비밀번호 변경

일반적인 **테이블의 데이터 변경은 허용**된다.  
MySQL 서버의 구성은 **소스 서버**와 **레플리카 서버**로 구성되는데, 주로 백업은 레플리카 서버에서 실행된다.  

## 테이블 락