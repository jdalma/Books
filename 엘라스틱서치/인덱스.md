
# 인덱스 설정

인덱스 설정을 조회하려면 `GET [인덱스 이름]/_settings`로 조회할 수 있다.  
사전에 존재하지 않는 인덱스에 문서 색인을 요청하면 ES는 인덱스를 자동으로 생성한다.  

```json
// req
GET my_index/_settings

// res
{
  "my_index": {
    "settings": {
      "index": {
        "routing": {
          "allocation": {
            "include": {
              "_tier_preference": "data_content"
            }
          }
        },
        "number_of_shards": "1",
        "provided_name": "my_index",
        "creation_date": "1701589928336",
        "number_of_replicas": "1",
        "uuid": "D04h6TQ4TneP3YMujx8rHA",
        "version": {
          "created": "8040299"
        }
      }
    }
  }
}
```

## number_of_shards

이 인덱스가 데이터를 몇 개의 샤드로 쪼갤 것인지 지정하는 값이다.  
이 값은 한 번 지정하면 `reindex` 같은 동작을 통해 인덱스를 통째로 재색인하는 등 특별한 작업을 수행하지 않는 한 바꿀 수 없기 때문에 신중하게 설계해야 한다.  
  
샤드 개수를 어떻게 지정하느냐는 엘라스틱서치 클러스터 전체의 성능에도 큰 영향을 미친다.  
**샤드 하나마다 루씬 인덱스가 하나씩 더 생성된다는 사실과 주 샤드 하나당 복제본 샤드도 늘어난다.**  
  
클러스터에 샤드 숫자가 너무 많아지면 클러스터 성능이 떨어지며 특히 색인 성능이 감소한다.  
그러나 인덱스당 샤드 숫자를 적게 지정하면 샤드 하나의 크기가 커진다.  
샤드의 크기가 커지면 장애 상황 등에서 복구에 너무 많은 시간이 소요되고 특히 클러스터 안정성이 떨어진다.  
  
TODO(6.4 샤드 운영 전략)

# number_of_replicas

주 샤드 하나당 복제본 샤드를 몇 개 둘 것인지를 지정하는 설정이다.  
ES 클러스터에 몇 개의 노드를 붙일 것이며 어느 정도의 고가용성을 제공할 것인지 등을 고려해서 지정하면 된다.  
이 값은 인덱스 생성 후에도 동적으로 변경할 수 있다.  
  
값을 0으로 설정하여 복제본 샤드를 생성하지 않는 설정은 주로 대용량의 초기 데이터를 마이그레이션 하는 등의 시나리오에서 쓰기 성능을 일시적으로 끌어올리기 위해 사용한다.  

# refresh_interval

해당 인덱스를 대상으로 refresh를 얼마나 자주 수행할 것인지를 지정한다.  

```json
PUT my_index/_settings
{
    "index.refresh_interval": "1s"
}
```

`-1`로 지정하면 주기적 refresh를 수행하지 않는다.  

```json
{
  "my_index": {
    "settings": {
      "index": {
        "routing": {
          "allocation": {
            "include": {
              "_tier_preference": "data_content"
            }
          }
        },
        "number_of_shards": "1",
        "provided_name": "my_index",
        "creation_date": "1701589928336",
        "number_of_replicas": "1",
        "uuid": "D04h6TQ4TneP3YMujx8rHA",
        "version": {
          "created": "8040299"
        }
      }
    }
  }
}
```

만약 위의 예제처럼 값이 명시적으로 설정되어 있지 않으면 매 1초마다 refresh를 수행하며, 마지막으로 검색 쿼리가 들어온 시각을 확인한다.  
30초 이상 검색 쿼리가 들어오지 않는 것을 확인하면 다음 첫 검색 쿼리가 들어올때 까지 refresh를 수행하지 않는다.  
이 대기시간도 `index.search.idle.after`로 설정할 수 있다.  
