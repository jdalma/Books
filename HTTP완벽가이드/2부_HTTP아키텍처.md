
# "5장" 웹 서버

## 5.1 다채로운 웹 서버

기능은 달라도, **모든 웹 서버는 리소스에 대한 HTTP 요청을 받아서 콘텐츠를 클라이언트에게 돌려준다.**  
**웹 서버는 HTTP 및 그와 관련된 TCP처리를 구현한 것이다.**  
- TCP 커넥션 관리에 대한 책임을 운영체제와 나눠 갖는다.

1. **커넥션을 맺는다.**
2. **요청을 받는다.** : HTTP 요청 메시지를 네트워크로부터 읽어들인다.
3. **요청을 처리한다.** : 요청 메시지를 해석하고 행동을 취한다.
4. **리소스에 접근한다.** : 메시지에서 지정한 리소스에 접근한다.
5. **응답을 만든다.** : 올바른 헤더를 포함한 HTTP 응답 메시지를 생성한다.
6. **응답을 보낸다.** : 응답을 클라이언트에게 돌려준다.
7.  **트랜잭션을 로그로 남긴다.** : 로그파일에 트랜잭션 완료에 대한 기록을 남긴다.
  
### **단계 1 : 클라이언트 커넥션 수락**

1. **새 커넥션 다루기**
   - 클라이언트가 웹 서버에 TCP 커넥션을 요청하면, **웹서버는 커넥션을 맺고 TCP 커넥션에서 IP 주소를 추출하여 커넥션 맞은편에 어떤 클라이언트가 있는지 확인한다.**  
   - 동일한 커넥션이 생성되지 않도록 새 커넥션을 커넥션 목록에 추가한다.  
2. **클라이언트 호스트 명 식별**
   - 대부분의 웹 서버는 `reverse DNS`를 사용해서 클라이언트의 IP 주소를 클라이언트의 호스트 명으로 반환하도록 설정되어 있다.
   - 아파치에서는 `HostnameLookups` 설정 지시자로 호스트 명 룩업을 켤 수 있다.
3. **`ident`를 통해 클라이언트 사용자 알아내기**
   - [`RFC1413` Identification Protocol](https://www.rfc-editor.org/rfc/rfc1413)
   - 몇몇 웹서버는 `IETF ident 프로토콜`을 지원한다. 서버에게 어떤 사용자 이름이 HTTP 커넥션을 초기화했는지 찾아낼 수 있게 해준다.
   - 여러 이유로 인해 보통 `ident 로그 필드`를 `-`으로 채우며, 잘 사용되지 않는다.

### **단계 2 : 요청 메시지 수신**

커넥션에 데이터가 도착하면, 수신자는 네트워크 커넥션에서 데이터를 읽어들이고 파싱하여 요청 메시지를 구성한다.  

1. 요청줄을 파싱하여 `요청 메서드`, `지정된 리소스의 식별자(URI)`, `버전 번호`를 찾는다.
   1. 각 값은 스페이스 한 개로 분리되어 있고, 요청줄은 캐리지 줄바꿈 문자열(CRLF)로 끝난다.
2. 메시지 헤더들을 읽는다. 각 메시지 헤더도 CRLF로 끝난다.
3. 헤더의 끝을 의미하는 CRLF로 끝나는 빈 줄을 찾아낸다 (존재한다면)
4. 요청 본문이 있다면 길이는 `Content-Length` 헤더로 정의하며, 본문을 읽어들인다.
  
#### 메시지의 내부 표현

몇몇 웹 서버는 요청 메시지를 쉽게 다룰 수 있도록 내부의 자료 구조에 저장한다.  

![](imgs/messageExpression.png)

#### 커넥션 I/O 아키텍처 📌

고성능 웹 서버는 수천 개의 커넥션을 동시에 열 수 있도록 지원한다.  
**웹 서버 아키텍처의 차이에 따라 요청을 처리하는 방식도 달라진다.**  

![](imgs/connectionArchitecture.png)

- **단일 스레드 웹 서버**
- **멀티프로세스와 멀티스레드 웹 서버**
- **다중 I/O 서버**
- **다중 멀티스레드 웹 서버**